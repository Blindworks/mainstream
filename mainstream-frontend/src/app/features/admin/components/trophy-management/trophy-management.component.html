<div class="trophy-management-container">
  <div class="management-header">
    <h3>Trophy & Winner Management</h3>
  </div>

  <!-- Alerts -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <!-- Trophy CRUD Section -->
  <div class="trophy-crud-section">
    <div class="section-header">
      <h3>Trophy Management</h3>
      <button
        class="btn btn-primary"
        (click)="openCreateForm()"
        [disabled]="loading || showTrophyForm">
        + Create New Trophy
      </button>
    </div>

    <!-- Trophy Form (Create/Edit) -->
    <div *ngIf="showTrophyForm" class="trophy-form-container">
      <div class="form-header">
        <h4>{{ editingTrophy ? 'Edit Trophy' : 'Create New Trophy' }}</h4>
        <button class="btn-close" (click)="cancelForm()" [disabled]="loading">√ó</button>
      </div>

      <form class="trophy-form" (ngSubmit)="saveTrophy()">
        <div class="form-row">
          <div class="form-group">
            <label for="code">Code*</label>
            <input
              type="text"
              id="code"
              [(ngModel)]="trophyForm.code"
              name="code"
              [disabled]="!!editingTrophy || loading"
              placeholder="e.g., DISTANCE_10KM"
              required>
            <small *ngIf="editingTrophy" class="help-text">Code cannot be changed</small>
          </div>

          <div class="form-group">
            <label for="name">Name*</label>
            <input
              type="text"
              id="name"
              [(ngModel)]="trophyForm.name"
              name="name"
              [disabled]="loading"
              placeholder="e.g., 10 km L√§ufer"
              required>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description*</label>
          <textarea
            id="description"
            [(ngModel)]="trophyForm.description"
            name="description"
            [disabled]="loading"
            rows="3"
            placeholder="Describe the trophy and how to earn it..."
            required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="type">Type*</label>
            <select
              id="type"
              [(ngModel)]="trophyForm.type"
              name="type"
              [disabled]="!!editingTrophy || loading"
              required>
              <option *ngFor="let type of trophyTypes" [value]="type">
                {{ getTrophyTypeLabel(type) }}
              </option>
            </select>
            <small *ngIf="editingTrophy" class="help-text">Type cannot be changed</small>
          </div>

          <div class="form-group">
            <label for="category">Category*</label>
            <select
              id="category"
              [(ngModel)]="trophyForm.category"
              name="category"
              [disabled]="!!editingTrophy || loading"
              required>
              <option *ngFor="let category of trophyCategories" [value]="category">
                {{ getTrophyCategoryLabel(category) }}
              </option>
            </select>
            <small *ngIf="editingTrophy" class="help-text">Category cannot be changed</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="iconUrl">Icon URL</label>
            <input
              type="text"
              id="iconUrl"
              [(ngModel)]="trophyForm.iconUrl"
              name="iconUrl"
              [disabled]="loading"
              placeholder="https://example.com/icon.png">
          </div>

          <div class="form-group">
            <label for="criteriaValue">Criteria Value</label>
            <input
              type="number"
              id="criteriaValue"
              [(ngModel)]="trophyForm.criteriaValue"
              name="criteriaValue"
              [disabled]="loading"
              placeholder="e.g., 10000 for 10km">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="displayOrder">Display Order</label>
            <input
              type="number"
              id="displayOrder"
              [(ngModel)]="trophyForm.displayOrder"
              name="displayOrder"
              [disabled]="loading"
              placeholder="Lower numbers appear first">
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="trophyForm.isActive"
                name="isActive"
                [disabled]="loading">
              Active
            </label>
          </div>
        </div>

        <!-- Location-based Trophy Fields -->
        <div *ngIf="isLocationBasedType()" class="location-fields">
          <h4 class="section-title">Location-Based Trophy Settings</h4>

          <div class="form-row">
            <div class="form-group">
              <label for="latitude">Latitude*</label>
              <input
                type="number"
                id="latitude"
                [(ngModel)]="trophyForm.latitude"
                name="latitude"
                [disabled]="loading"
                step="0.000001"
                placeholder="e.g., 48.137154"
                required>
            </div>

            <div class="form-group">
              <label for="longitude">Longitude*</label>
              <input
                type="number"
                id="longitude"
                [(ngModel)]="trophyForm.longitude"
                name="longitude"
                [disabled]="loading"
                step="0.000001"
                placeholder="e.g., 11.576124"
                required>
            </div>
          </div>

          <div class="form-group">
            <label for="collectionRadiusMeters">Collection Radius (meters)*</label>
            <input
              type="number"
              id="collectionRadiusMeters"
              [(ngModel)]="trophyForm.collectionRadiusMeters"
              name="collectionRadiusMeters"
              [disabled]="loading"
              placeholder="e.g., 50"
              required>
            <small class="help-text">How close the runner must get to collect the trophy</small>
          </div>

          <div class="form-group">
            <label for="imageUrl">Trophy Image URL</label>
            <input
              type="text"
              id="imageUrl"
              [(ngModel)]="trophyForm.imageUrl"
              name="imageUrl"
              [disabled]="loading"
              placeholder="https://example.com/trophy-image.png">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="validFrom">Valid From</label>
              <input
                type="datetime-local"
                id="validFrom"
                [(ngModel)]="trophyForm.validFrom"
                name="validFrom"
                [disabled]="loading">
              <small class="help-text">Start date when trophy becomes available (optional)</small>
            </div>

            <div class="form-group">
              <label for="validUntil">Valid Until</label>
              <input
                type="datetime-local"
                id="validUntil"
                [(ngModel)]="trophyForm.validUntil"
                name="validUntil"
                [disabled]="loading">
              <small class="help-text">End date when trophy expires (optional)</small>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancelForm()" [disabled]="loading">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            <span *ngIf="loading" class="spinner"></span>
            <span *ngIf="!loading">{{ editingTrophy ? 'Update Trophy' : 'Create Trophy' }}</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Trophy List -->
    <div class="trophies-list-section">
      <div *ngIf="loadingTrophies" class="loading">
        <div class="spinner-large"></div>
        <p>Loading trophies...</p>
      </div>

      <div *ngIf="!loadingTrophies && trophies.length === 0" class="empty-state">
        <div class="empty-icon">üèÜ</div>
        <h3>No Trophies Yet</h3>
        <p>Create your first trophy to get started.</p>
      </div>

      <div *ngIf="!loadingTrophies && trophies.length > 0" class="trophies-grid">
        <div *ngFor="let trophy of trophies" class="trophy-card" [class.inactive]="!trophy.isActive">
          <div class="trophy-header">
            <div class="trophy-title">
              <h4>{{ trophy.name }}</h4>
              <span class="trophy-code">{{ trophy.code }}</span>
            </div>
            <div class="trophy-status">
              <span class="status-badge" [class.active]="trophy.isActive" [class.inactive]="!trophy.isActive">
                {{ trophy.isActive ? 'Active' : 'Inactive' }}
              </span>
            </div>
          </div>

          <div class="trophy-body">
            <p class="trophy-description">{{ trophy.description }}</p>

            <div class="trophy-details">
              <div class="detail-item">
                <span class="detail-label">Type:</span>
                <span class="detail-value">{{ getTrophyTypeLabel(trophy.type) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Category:</span>
                <span class="detail-value">{{ getTrophyCategoryLabel(trophy.category) }}</span>
              </div>
              <div *ngIf="trophy.criteriaValue" class="detail-item">
                <span class="detail-label">Criteria:</span>
                <span class="detail-value">{{ trophy.criteriaValue }}</span>
              </div>
              <div *ngIf="trophy.displayOrder" class="detail-item">
                <span class="detail-label">Order:</span>
                <span class="detail-value">{{ trophy.displayOrder }}</span>
              </div>
            </div>
          </div>

          <div class="trophy-actions">
            <button
              class="btn btn-small btn-secondary"
              (click)="toggleTrophyActive(trophy)"
              [disabled]="loading">
              {{ trophy.isActive ? 'Deactivate' : 'Activate' }}
            </button>
            <button
              class="btn btn-small btn-primary"
              (click)="openEditForm(trophy)"
              [disabled]="loading || showTrophyForm">
              Edit
            </button>
            <button
              class="btn btn-small btn-danger"
              (click)="deleteTrophy(trophy)"
              [disabled]="loading">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Actions -->
  <div class="admin-actions">
    <div class="action-card">
      <h3>Initialize Trophies</h3>
      <p>Create default trophy definitions for the system (distance milestones and streak achievements).</p>
      <button
        class="btn btn-primary"
        (click)="initializeTrophies()"
        [disabled]="loading">
        <span *ngIf="loading" class="spinner"></span>
        <span *ngIf="!loading">Initialize Trophies</span>
      </button>
    </div>

    <div class="action-card">
      <h3>Update Trophy Configs</h3>
      <p>Update trophy configurations with criteriaConfig JSON for existing trophies.</p>
      <button
        class="btn btn-primary"
        (click)="updateTrophyConfigs()"
        [disabled]="loading">
        <span *ngIf="loading" class="spinner"></span>
        <span *ngIf="!loading">Update Configs</span>
      </button>
    </div>

    <div class="action-card">
      <h3>Calculate Daily Winners</h3>
      <p>Manually trigger daily winner calculation for all categories (normally runs automatically at 23:59).</p>
      <button
        class="btn btn-success"
        (click)="calculateDailyWinners()"
        [disabled]="loading">
        <span *ngIf="loading" class="spinner"></span>
        <span *ngIf="!loading">Calculate Winners</span>
      </button>
    </div>
  </div>

  <!-- Recent Winners -->
  <div class="recent-winners">
    <div class="section-header">
      <h3>Recent Winners (Last 7 Days)</h3>
      <button
        class="btn btn-secondary btn-small"
        (click)="loadRecentWinners()"
        [disabled]="loadingWinners">
        Refresh
      </button>
    </div>

    <div *ngIf="loadingWinners" class="loading">
      <div class="spinner-large"></div>
      <p>Loading winners...</p>
    </div>

    <div *ngIf="!loadingWinners && recentWinners.length === 0" class="empty-state">
      <div class="empty-icon">üèÜ</div>
      <h3>No Winners Yet</h3>
      <p>Daily winners will appear here once calculated.</p>
    </div>

    <div *ngIf="!loadingWinners && recentWinners.length > 0" class="winners-list">
      <div *ngFor="let winner of recentWinners" class="winner-card">
        <div class="winner-header">
          <div class="winner-category">
            <span class="category-icon">üèÜ</span>
            <span class="category-name">{{ getCategoryLabel(winner.category) }}</span>
          </div>
          <span class="winner-date">{{ formatDate(winner.winnerDate) }}</span>
        </div>

        <div class="winner-info">
          <div class="winner-user">
            <strong>User ID:</strong> {{ winner.userId }}
          </div>

          <div *ngIf="winner.activityId" class="winner-activity">
            <strong>Activity ID:</strong> {{ winner.activityId }}
          </div>

          <div *ngIf="winner.achievementValue" class="winner-value">
            <strong>Value:</strong> {{ winner.achievementValue }}
          </div>

          <div *ngIf="winner.achievementDescription" class="winner-description">
            {{ winner.achievementDescription }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
